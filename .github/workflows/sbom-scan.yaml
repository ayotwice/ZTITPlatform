# GitHub Actions Workflow: Daily SBOM Vulnerability Scan
#
# Scans software inventory across the fleet for new vulnerabilities.
# Alerts on critical findings for rapid incident response.

name: SBOM Vulnerability Scan

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  vulnerability-scan:
    name: Scan Fleet for Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Fetch Fleet SBOMs
        run: |
          # In production, this would pull SBOMs from Kandji or central store
          python -c "
          from src.supply_chain import SBOMManager
          manager = SBOMManager()
          manager.import_mock_data()
          print(f'Loaded {len(manager._sbom_cache)} device SBOMs')
          "

      - name: Run Vulnerability Scan
        id: scan
        run: |
          python -c "
          import json
          from src.supply_chain import SBOMManager, VulnerabilityScanner

          # Initialize
          sbom_manager = SBOMManager()
          sbom_manager.import_mock_data()
          scanner = VulnerabilityScanner(sbom_manager)

          # Scan fleet
          report = scanner.get_vulnerability_report()

          # Output results
          print(json.dumps(report, indent=2))

          # Set outputs for subsequent steps
          with open('scan_report.json', 'w') as f:
              json.dump(report, f)

          # Fail if critical vulnerabilities found
          if report['devices_with_critical'] > 0:
              print(f\"::error::Found {report['devices_with_critical']} devices with critical vulnerabilities\")
              exit(1)
          "
        continue-on-error: true

      - name: Upload Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report
          path: scan_report.json
          retention-days: 30

      - name: Create Issue for Critical Findings
        if: steps.scan.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('scan_report.json', 'utf8'));

            const body = `## ðŸš¨ Critical Vulnerabilities Detected

            A scheduled SBOM scan has detected critical vulnerabilities in the fleet.

            ### Summary
            - **Devices Scanned**: ${report.fleet_size}
            - **Devices with Critical**: ${report.devices_with_critical}
            - **Total Vulnerabilities**: ${report.total_vulnerabilities}
            - **Unique CVEs**: ${report.unique_cves}

            ### Most Prevalent
            ${report.most_prevalent.map(v => `- ${v.cve_id}: ${v.affected_devices} devices`).join('\n')}

            ### Required Actions
            1. Review affected devices
            2. Apply available patches immediately
            3. Consider blocking access from unpatched devices
            4. Update this issue with remediation progress

            ---
            *Generated by SBOM Vulnerability Scan workflow*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CRITICAL] Vulnerability Scan Alert - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'critical', 'vulnerability']
            });

      - name: Send Slack Alert
        if: steps.scan.outcome == 'failure'
        run: |
          # In production, would send to Slack webhook
          echo "Would send Slack alert for critical vulnerabilities"
